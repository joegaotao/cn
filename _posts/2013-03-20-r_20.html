--- 
layout: post
name: r_20
title: "R\xE8\xAF\xAD\xE8\xA8\x80\xE7\x8E\xA9\xE8\xBD\xAC\xE8\xB5\x84\xE4\xBA\xA7\xE7\xBB\x84\xE5\x90\x88\xE8\xAE\xA1\xE7\xAE\x97"
date: 2013-03-20 19:53:00 +08:00
categories: 
- "\xE9\x87\x91\xE8\x9E\x8D\xE8\xAE\xA1\xE7\xAE\x97"
- "\xE6\x9C\x80\xE4\xBC\x98\xE5\x8C\x96"
permalink: /2013/03/r_20.html
---
<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-EhxOvxO0Xqs/UUmhu0Zk3HI/AAAAAAAABZw/vFuoqZNxwbQ/s1600/unnamed-chunk-21.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://3.bp.blogspot.com/-EhxOvxO0Xqs/UUmhu0Zk3HI/AAAAAAAABZw/vFuoqZNxwbQ/s320/unnamed-chunk-21.png" width="320" /></a></div>以前都是用MATLAB或是EXCEL给学生讲资产组合的计算问题，实际R语言也可以做一样的事情。资产组合要解决的问题并不复杂，即给定一个可选的资产集合，要从中选择出一个最优组合，使其收益率较大，而风险较小。如果可选资产只有两个的话，问题非常简单，可以通过求导最优化的方式得到结果，即有效资产前沿的解析解。如果资产集合超过两个那么问题要复杂一些。首先需要给定一个要求的期望收益率，再求出在此约束下的方差最小组合，这可以通过二次规划解出。这样得到有效前沿上的一个点。然后更改期望收益率，又可以得到另一个最优解，如此反复即可得到多资产组合的有效前沿。<br /><br />下面我们先用R语言中quadprog包的二次规划求解函数来计算一个例子，再用fPortfolio包中的函数来完成同样的任务。例子中使用的数据来自于fPortfolio包中的SMALLCAP.RET数据集，使用了其中的四个资产来示例。<br /><br /><a name='more'></a><br /><br /><pre class="r geshifilter-R"><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/quadprog">quadprog</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/library"><span style="color: #003399; font-weight: bold;">library</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/fPortfolio">fPortfolio</a><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a> &lt;- SMALLCAP.RET<span style="color: #009900;">[</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: blue;">"BKE"</span><span style="color: #339933;">,</span> <span style="color: blue;">"GG"</span><span style="color: #339933;">,</span> <span style="color: blue;">"GYMB"</span><span style="color: #339933;">,</span> <span style="color: blue;">"KRON"</span><span style="color: #009900;">)</span><span style="color: #009900;">]</span><br /><span style="color: #666666; font-style: italic;"># 计算得到收益率数据的协方差矩阵和期望</span><br />sigma &lt;- covEstimator<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a><span style="color: #009900;">)</span>$Sigma<br />mu &lt;- covEstimator<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a><span style="color: #009900;">)</span>$mu<br /><span style="color: #666666; font-style: italic;"># 计算给定期望收益率为0.03条件下的最优组合，且不可作空</span><br />A &lt;- <a href="http://inside-r.org/r-doc/base/cbind"><span style="color: #003399; font-weight: bold;">cbind</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/rep"><span style="color: #003399; font-weight: bold;">rep</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">4</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span> mu<span style="color: #339933;">,</span><a href="http://inside-r.org/r-doc/base/diag"><span style="color: #003399; font-weight: bold;">diag</span></a><span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/base/rep"><span style="color: #003399; font-weight: bold;">rep</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">4</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;">#约束系数</span><br /><a href="http://inside-r.org/r-doc/stats/D"><span style="color: #003399; font-weight: bold;">D</span></a> &lt;- sigma <span style="color: #666666; font-style: italic;"># 协方差矩阵</span><br />x &lt;- mu <span style="color: #666666; font-style: italic;"># 期望收益</span><br />b &lt;- <a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">1</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">0.03</span><span style="color: #339933;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0</span><span style="color: #009900;">)</span> <span style="color: #666666; font-style: italic;">#约束的右侧值</span><br />res &lt;- solve.QP<span style="color: #009900;">(</span><span style="color: #cc66cc;">2</span> * <a href="http://inside-r.org/r-doc/stats/D"><span style="color: #003399; font-weight: bold;">D</span></a><span style="color: #339933;">,</span> x<span style="color: #339933;">,</span> A<span style="color: #339933;">,</span> b<span style="color: #339933;">,</span> meq=<span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/round"><span style="color: #003399; font-weight: bold;">round</span></a><span style="color: #009900;">(</span>res$solution<span style="color: #339933;">,</span><span style="color: #cc66cc;">2</span><span style="color: #009900;">)</span></pre><br />得到最优资产组合的权重向量为0.26，0.26，0.00，0.48，quadprog包的二次规划求解在设置参数上不那么直观，而且不能够直接计算原始数据。更为方便的是使用fPortfolio包中的系列函数。下面使用efficientPortfolio()函数来计算给定期望下的最优组合，使用前需要设定函数所需的参数，一个用来表示组合的设定，另一个用来表示组合的约束。<br /><br /><pre class="r geshifilter-R"><span style="color: #666666; font-style: italic;"># 设定组合的期望收益率为0.03</span><br />spec &lt;- portfolioSpec<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/portfolio">portfolio</a>=<a href="http://inside-r.org/r-doc/base/list"><span style="color: #003399; font-weight: bold;">list</span></a><br />                       <span style="color: #009900;">(</span>targetReturn=<span style="color: #cc66cc;">0.03</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 设定组合的约束不许做空</span><br />cons &lt;- <span style="color: blue;">'LongOnly'</span><br /><span style="color: #666666; font-style: italic;"># 求解</span><br />res &lt;- efficientPortfolio<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a><span style="color: #339933;">,</span> spec = spec<span style="color: #339933;">,</span> <br />                          constraints = cons<span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/base/summary"><span style="color: #003399; font-weight: bold;">summary</span></a><span style="color: #009900;">(</span>res<span style="color: #009900;">)</span></pre><br />存在res中的输出结果非常丰富，其中包括了最优组合的权重，以及在此权重下的组合期望收益率和组合标准差，此外还提供了组合的风险价值VaR和条件风险价值CVaR。输出中的风险预算表示各资产对组合风险的贡献比例，可见KRON所占风险最高。我们还可以计算出有效前沿上的所有组合并绘制成图。<br /><div style="overflow: auto;"><div class="geshifilter"><pre class="r geshifilter-R" style="font-family: monospace;"><span style="color: #666666; font-style: italic;"># 设定计算出前沿上的100个最优组合，无风险资产收益率为0.01</span><br />spec &lt;- portfolioSpec<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/portfolio">portfolio</a>=<a href="http://inside-r.org/r-doc/base/list"><span style="color: #003399; font-weight: bold;">list</span></a><br />                       <span style="color: #009900;">(</span>nFrontierPoints = <span style="color: #cc66cc;">100</span><span style="color: #339933;">,</span> <br />                       riskFreeRate=<span style="color: #cc66cc;">0.01</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 计算有效前沿，并不许做空</span><br /><a href="http://inside-r.org/packages/cran/frontier">frontier</a> &lt;- portfolioFrontier<span style="color: #009900;">(</span><a href="http://inside-r.org/r-doc/utils/data"><span style="color: #003399; font-weight: bold;">data</span></a><span style="color: #339933;">,</span>spec=spec<span style="color: #339933;">,</span><br />                             constraints = cons<span style="color: #009900;">)</span><br /><span style="color: #666666; font-style: italic;"># 有效前沿绘图</span><br />frontierPlot<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/frontier">frontier</a><span style="color: #339933;">,</span> <br />             pch = <span style="color: #cc66cc;">19</span><span style="color: #339933;">,</span><br />             cex = <span style="color: #cc66cc;">0.5</span><span style="color: #339933;">,</span><br />             xlim=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0.25</span><span style="color: #009900;">)</span><span style="color: #339933;">,</span><br />             ylim=<a href="http://inside-r.org/r-doc/base/c"><span style="color: #003399; font-weight: bold;">c</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span><span style="color: #cc66cc;">0.035</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/graphics/grid"><span style="color: #003399; font-weight: bold;">grid</span></a><span style="color: #009900;">(</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/graphics/abline"><span style="color: #003399; font-weight: bold;">abline</span></a><span style="color: #009900;">(</span>h = <span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/col"><span style="color: #003399; font-weight: bold;">col</span></a> = <span style="color: blue;">"grey30"</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/graphics/abline"><span style="color: #003399; font-weight: bold;">abline</span></a><span style="color: #009900;">(</span>v = <span style="color: #cc66cc;">0</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/col"><span style="color: #003399; font-weight: bold;">col</span></a> = <span style="color: blue;">"grey30"</span><span style="color: #009900;">)</span><br />minvariancePoints<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/frontier">frontier</a><span style="color: #339933;">,</span> pch = <span style="color: #cc66cc;">19</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/col"><span style="color: #003399; font-weight: bold;">col</span></a> = <span style="color: blue;">"red"</span><span style="color: #009900;">)</span><br />tangencyPoints<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/frontier">frontier</a><span style="color: #339933;">,</span> pch = <span style="color: #cc66cc;">19</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/col"><span style="color: #003399; font-weight: bold;">col</span></a> = <span style="color: blue;">"blue"</span><span style="color: #009900;">)</span><br />tangencyLines<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/frontier">frontier</a><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/col"><span style="color: #003399; font-weight: bold;">col</span></a> = <span style="color: blue;">"darkblue"</span><span style="color: #339933;">,</span>lwd=<span style="color: #cc66cc;">3</span><span style="color: #009900;">)</span><br />singleAssetPoints<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/frontier">frontier</a><span style="color: #339933;">,</span> pch = <span style="color: #cc66cc;">19</span><span style="color: #339933;">,</span> cex = <span style="color: #cc66cc;">1.5</span><span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/col"><span style="color: #003399; font-weight: bold;">col</span></a> = <a href="http://inside-r.org/r-doc/grDevices/topo.colors"><span style="color: #003399; font-weight: bold;">topo.colors</span></a><span style="color: #009900;">(</span><span style="color: #cc66cc;">6</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><br />front &lt;- frontierPoints<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/frontier">frontier</a><span style="color: #009900;">)</span><br />monteCarloPoints<span style="color: #009900;">(</span><a href="http://inside-r.org/packages/cran/frontier">frontier</a><span style="color: #339933;">,</span> mcSteps = <span style="color: #cc66cc;">500</span><span style="color: #339933;">,</span> pch = <span style="color: #cc66cc;">19</span><span style="color: #339933;">,</span><br />cex = <span style="color: #cc66cc;">0.3</span><span style="color: #009900;">)</span><br /><a href="http://inside-r.org/r-doc/graphics/lines"><span style="color: #003399; font-weight: bold;">lines</span></a><span style="color: #009900;">(</span>front<span style="color: #339933;">,</span> <a href="http://inside-r.org/r-doc/base/col"><span style="color: #003399; font-weight: bold;">col</span></a> = <span style="color: blue;">"red4"</span><span style="color: #339933;">,</span> lwd = <span style="color: #cc66cc;">3</span><span style="color: #009900;">)</span></pre><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-tPKxWCXMtOY/UUmiuVCTd7I/AAAAAAAABZ4/pBBT6DlO_To/s1600/unnamed-chunk-3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-tPKxWCXMtOY/UUmiuVCTd7I/AAAAAAAABZ4/pBBT6DlO_To/s1600/unnamed-chunk-3.png" /></a></div><pre class="r geshifilter-R" style="font-family: monospace;"><span style="color: #009900;"><br /></span></pre></div></div>
